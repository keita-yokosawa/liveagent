<html>

  <head>
    <title>CHAT PAGE FOR MEMBER</title>
  </head>

  <body>
	<script type='text/javascript'>

       function embeddedMsgLoaded() {
        var embeddedMsg = document.getElementById('embeddedMessagingModalOverlay');
		//var embeddedMsg = document.getElementById('embeddedMessagingFrame');
	    console.log(embeddedMsg);
        if (!embeddedMsg) {
          window.setTimeout(embeddedMsgLoaded, 500);
          return;
        }
		//if(embeddedMsg) { 
            console.log('height=' + embeddedMsg.height );
            console.log('clientWidth=' + embeddedMsg.width );
            var height = embeddedMsg.clientHeight + 24;
            var width = embeddedMsg.clientWidth + 36;
		    // var embeddedMsgMV = document.getElementById('embeddedMessagingModalOverlay');
		    // if (!embeddedMsgMV) {
		    // 	embeddedMsgMV.remove();
		    // 	console.log('embeddedMessagingModalOverlay is deleted!');
		    // }
		    embeddedMsg.style.display = 'none';
		    window.parent.postMessage({frameHeight: 480,frameWidth: 321}, '*'); 
		    //embeddedMsg.style.height="100%";
            //window.parent.postMessage({frameHeight: 580,frameWidth: 320}, '*'); 
		//}
      }
		//window.onload = test();
		let countTimeout = 0;
		const maxExecutionsTimeout = 5;
		
		function test(){
		   var embeddedMsg1 = document.getElementById('embeddedMessagingModalOverlay');
		   countTimeout++;
		   if(embeddedMsg1){
			   console.log('find embeddedMessagingModalOverlay');
			   embeddedMsg1.style.display = 'none';
			   window.parent.postMessage({frameHeight: 480,frameWidth: 321}, '*'); 
			   console.log(embeddedMsg1);
		   }else{
			   if (countTimeout < maxExecutionsTimeout) {
			       window.setTimeout(test, 500);
			   }
		       console.log('this is not embeddedMessagingModalOverlay');
		   }
		}
		function reDefineSize(){
		    const key = "child_iframe_loaded";
			console.log("localStorage__:" + localStorage.getItem(key));
			if(localStorage.getItem(key)){
				console.log("F5/Reload__" + localStorage.getItem(key));
				test();
			}else{
				console.log("初回ロード");
				localStorage.setItem(key,"1");
			}
		}
		var crmContractNo;
		var fields = {};
		console.log("crmContractNo: "  + crmContractNo);
		window.addEventListener("onEmbeddedMessagingReady", () => {
	    	console.log("Received the onEmbeddedMessagingReady event…");
	    	console.log("the contractNo is "  + crmContractNo);
	    	if (crmContractNo) {
		  		fields.contractNo = crmContractNo;
			}
			embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields(fields);
		});

		window.addEventListener("onEmbeddedMessagingButtonClicked", () => {
	    	console.log("Fires the first time the chat button is clicked by the end user.…");
	    	console.log("the contractNo is "  + crmContractNo);
　　　　　　　embeddedMsgLoaded();
		});

	   // window.addEventListener("onEmbeddedMessagingConversationStarted", (event) => {
    //        console.log("Received the onEmbeddedMessagingConversationStarted event…");
    //        console.log("Event detail: ", event.detail);
    //        embeddedMsgLoaded();
    //        // Do something...
    //    });

		// document.addEventListener("DOMContentLoaded", () => {
	 //    	console.log("DOMContentLoaded.…");
　　// 　　　　　test();
		// });
		window.onreload = reDefineSize();
		
		
		// window.addEventListener("onEmbeddedMessagingWindowMinimized", () => {
	 //    	console.log(" end user clicks the Close (X) button.…");
  //      //      var embeddedMsg = document.getElementById('embeddedMessagingModalOverlay');
	 //      //   console.log(embeddedMsg);
  //      //      if (!embeddedMsg) {
  //      //         window.setTimeout(embeddedMsgLoaded, 500);
  //      //         return;
  //      //       }
  //      //       console.log('height=' + embeddedMsg.clientHeight );
  //      //       console.log('clientWidth=' + embeddedMsg.clientWidth );
  //      //       var height = embeddedMsg.clientHeight + 24;
  //      //       var width = embeddedMsg.clientWidth + 36;
		//      // embeddedMsg.style.display = 'none';
		//      window.parent.postMessage({frameHeight: 180,frameWidth: 180}, '*'); 
		//  });
		
		function initEmbeddedMessaging() {
			try {
				embeddedservice_bootstrap.settings.language = 'ja'; // For example, enter 'en' or 'en-US'

				embeddedservice_bootstrap.init(
					'00D0l0000003gBr',
					'MessagingWebReleaseTest',
					'https://occ-crown--partial.sandbox.my.site.com/ESWMessagingWebRelease',
					{
						scrt2URL: 'https://occ-crown--partial.sandbox.my.salesforce-scrt.com'
					}
				);
			} catch (err) {
				console.error('Error loading Embedded Messaging: ', err);
			}
		};
	</script>
	<script type='text/javascript' src='https://occ-crown--partial.sandbox.my.site.com/ESWMessagingWebRelease/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>
  </body>
  
</html>
