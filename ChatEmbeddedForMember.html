<html>

  <head>
    <title>CHAT PAGE FOR MEMBER</title>
  </head>

  <body>
	<script type='text/javascript'>
       //チャット開始ボタン押下時、ウィンドウサイズと背景色変更
       function embeddedMsgLoaded() {
        var embeddedMsg = document.getElementById('embeddedMessagingModalOverlay');
	    console.log(embeddedMsg);
        if (!embeddedMsg) {
          window.setTimeout(embeddedMsgLoaded, 500);
          return;
        }
		embeddedMsg.style.display = 'none';
		window.parent.postMessage({frameHeight: 480,frameWidth: 321}, '*'); 
        }
		
		let countTimeout = 0;
		const maxExecutionsTimeout = 5;
		//F5押下や画面リロード時、ウィンドウサイズと背景色変更
		//チャット未開始の場合、対象Element検索が5回のみ（2秒）実施
		function resetSizeAndBackground(){
		   var embeddedMsg1 = document.getElementById('embeddedMessagingModalOverlay');
		   countTimeout++;
		   if(embeddedMsg1){
			   console.log('find embeddedMessagingModalOverlay');
			   embeddedMsg1.style.display = 'none';
			   window.parent.postMessage({frameHeight: 480,frameWidth: 321}, '*'); 
			   console.log(embeddedMsg1);
		   }else{
			   if (countTimeout < maxExecutionsTimeout) {
			       window.setTimeout(resetSizeAndBackground, 500);
			   }
		       console.log('this is not embeddedMessagingModalOverlay');
		   }
		}
		//画面初期表示とリロード区別し、ウィンドウと背景色変更
		function reDefineSize(){
		    const key = "child_iframe_loaded";
			console.log("localStorage__:" + localStorage.getItem(key));
			if(localStorage.getItem(key)){
				console.log("F5/Reload__" + localStorage.getItem(key));
				resetSizeAndBackground();
			}else{
				console.log("初回ロード");
				localStorage.setItem(key,"1");
			}
		}
		//契約番号を事前チャットに渡す
		var crmContractNo;
		var fields = {};
		console.log("crmContractNo: "  + crmContractNo);
		window.addEventListener("onEmbeddedMessagingReady", () => {
	    	console.log("Received the onEmbeddedMessagingReady event…");
	    	console.log("the contractNo is "  + crmContractNo);
	    	if (crmContractNo) {
		  		fields.contractNo = crmContractNo;
			}
			embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields(fields);
		});
        //チャット開始ボタン
		window.addEventListener("onEmbeddedMessagingButtonClicked", () => {
	    	console.log("Fires the first time the chat button is clicked by the end user.…");
	    	console.log("the contractNo is "  + crmContractNo);
			embeddedMsgLoaded();
		});

		//画面リロードイベント
		window.onreload = reDefineSize();
        //メッセージング初期化処理
		function initEmbeddedMessaging() {
			try {
				embeddedservice_bootstrap.settings.language = 'ja'; // For example, enter 'en' or 'en-US'

				embeddedservice_bootstrap.init(
					'00D0l0000003gBr',
					'MessagingWebReleaseTest',
					'https://occ-crown--partial.sandbox.my.site.com/ESWMessagingWebRelease',
					{
						scrt2URL: 'https://occ-crown--partial.sandbox.my.salesforce-scrt.com'
					}
				);
			} catch (err) {
				console.error('Error loading Embedded Messaging: ', err);
			}
		};
	</script>
	<script type='text/javascript' src='https://occ-crown--partial.sandbox.my.site.com/ESWMessagingWebRelease/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>
  </body>
  
</html>
