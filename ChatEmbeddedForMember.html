<html>

  <head>
    <title>CHAT PAGE FOR MEMBER</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  </head>

  <body>
	<script type='text/javascript'>
       //チャット開始ボタン押下時、ウィンドウサイズと背景色変更
       function embeddedMsgLoaded() {
        var embeddedMsg = document.getElementById('embeddedMessagingModalOverlay');
	    console.log(embeddedMsg);
        if (!embeddedMsg) {
          window.setTimeout(embeddedMsgLoaded, 500);
          return;
        }
		embeddedMsg.style.display = 'none';
		window.parent.postMessage({frameHeight: 480,frameWidth: 320}, '*');}
		
		let countTimeout = 0;
		const maxExecutionsTimeout = 5;
		//F5押下や画面リロード時、ウィンドウサイズと背景色変更
		//チャット未開始の場合、対象Element検索が5回のみ（2秒）実施
		function resetSizeAndBackground(){
		   var embeddedMsg1 = document.getElementById('embeddedMessagingModalOverlay');
		   countTimeout++;
		   if(embeddedMsg1){
			   console.log('find embeddedMessagingModalOverlay');
			   embeddedMsg1.style.display = 'none';
			   window.parent.postMessage({frameHeight: 480,frameWidth: 320}, '*');
		   }else{
			   if (countTimeout < maxExecutionsTimeout) {
			       window.setTimeout(resetSizeAndBackground, 500);
			   }
		       console.log('this is not embeddedMessagingModalOverlay');
		   }
		}
		//画面初期表示とリロード区別し、ウィンドウと背景色変更
		function reDefineSize(){
		    const key = "child_iframe_loaded";
			console.log("localStorage__:" + sessionStorage.getItem(key));
			if(sessionStorage.getItem(key)){
				console.log("F5/Reload__" + sessionStorage.getItem(key));
				resetSizeAndBackground();
			}else{
				console.log("初回ロード");
				sessionStorage.setItem(key,"1");
			}
		}
		function changeChatWindowSize(){
			var embededMsgFrm = document.getElementById('embeddedMessagingFrame');
			if(embededMsgFrm){
				console.log("clientHeight2 = " + embededMsgFrm.clientHeight);
				console.log("clientWidth2 = " + embededMsgFrm.clientWidth);
                var height = embededMsgFrm.clientHeight + 30;
                var width = embededMsgFrm.clientWidth + 36;
				console.log("clientHeight = " + height);
				console.log("clientWidth = " + width);
                window.parent.postMessage({
                    frameHeight: height,
                    frameWidth: width
                 }, '*');
			}else{
				console.log('can not find embeddedMessagingFrame....');
			}
		}
		function initWindowSize(){
			var embededMsgConBtn = document.getElementById('embeddedMessagingConversationButton');
			if(embededMsgConBtn){
				var isMaxed = sessionStorage.getItem("isMaximized");
				console.log("isMaxed = " + isMaxed);
				if(isMaxed && (isMaxed != "1")){ 
                    var height = 92;
                    var width = 98;
				    console.log("clientHeight = " + height);
				    console.log("clientWidth = " + width);
                    window.parent.postMessage({
                        frameHeight: height,
                        frameWidth: width
                    }, '*');
				}
			}else{
				console.log('can not find embeddedMessagingConversationButton....');
				window.setTimeout(initWindowSize, 500);
          		return;
			}
		}
		//契約番号を事前チャットに渡す
		var crmContractNo;
		var fields = {};
		console.log("crmContractNo: "  + crmContractNo);
		window.addEventListener("onEmbeddedMessagingReady", () => {
	    	console.log("Received the onEmbeddedMessagingReady event…");
	    	console.log("the contractNo is "  + crmContractNo);
	    	if (crmContractNo) {
		  		fields.contractNo = crmContractNo;
			}
			embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields(fields);
			initWindowSize();
		});
        //チャット開始ボタン
		window.addEventListener("onEmbeddedMessagingButtonClicked", () => {
	    	console.log("Fires the first time the chat button is clicked by the end user.…");
	    	console.log("the contractNo is "  + crmContractNo);
			embeddedMsgLoaded();
		});
	    //チャット最小化
		window.addEventListener("onEmbeddedMessagingWindowMinimized", () => {
	    	console.log("Fires when the messaging conversation window is minimized");
			changeChatWindowSize();
			sessionStorage.setItem("isMaximized","0");
			console.log("window is Maximized=" + sessionStorage.getItem("isMaximized"));
		});
	    //×ボタン
		window.addEventListener("onEmbeddedMessagingWindowClosed", () => {
	    	console.log("Fires when an end user clicks the Close (X) button");
            window.parent.postMessage({
                frameHeight: 92,
                frameWidth: 98
            }, '*');
		});
	    //チャット最大化
		window.addEventListener("onEmbeddedMessagingWindowMaximized", () => {
	    	console.log("Fires when the messaging conversation window is maximized.");
			embeddedMsgLoaded();
			sessionStorage.setItem("isMaximized","1");
			console.log("window is Maximized=" + sessionStorage.getItem("isMaximized"));
		});
		//画面リロードイベント
		window.onreload = reDefineSize();
        //メッセージング初期化処理
		function initEmbeddedMessaging() {
			try {
				embeddedservice_bootstrap.settings.language = 'ja'; // For example, enter 'en' or 'en-US'
				embeddedservice_bootstrap.init(
					'00D0l0000003BWM',
					'Enhanced_Chat_Agents',
					'https://d5h000004dhm5eae--dev.sandbox.my.site.com/ESWMessagingWebRelease',
					{
						scrt2URL: 'https://d5h000004dhm5eae--dev.sandbox.my.salesforce-scrt.com'
					}
				);
			} catch (err) {
				console.error('Error loading Embedded Messaging: ', err);
			}
		};
	</script>
    <script type='text/javascript' src='https://d5h000004dhm5eae--dev.sandbox.my.site.com/ESWMessagingWebRelease/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>
  </body>
  
</html>
